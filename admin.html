<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lehrer-Dashboard</title>
  <style>
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#E6F5FF; color:#333; }
    /* Auth Overlay */
    #auth-overlay {
      position: fixed; inset:0;
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(12px);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .auth-modal {
      background: #fff; border-radius:16px; padding:24px; width:min(90%,320px);
      box-shadow:0 20px 40px rgba(0,0,0,0.15); text-align:center;
    }
    .auth-modal h2 { margin:0 0 16px; font-size:1.25rem; font-weight:600; }
    .auth-modal input {
      width:100%; height:44px; padding:0 12px; margin-bottom:16px;
      border:1px solid #CCC; border-radius:12px; font-size:1rem; box-sizing:border-box;
    }
    .auth-modal button {
      width:100%; height:44px; background:#007AFF; color:#fff;
      border:none; border-radius:12px; font-size:1rem; font-weight:600; cursor:pointer;
    }
    .auth-modal button:active { background:#005BBB; }
    .auth-modal p { margin:12px 0 0; font-size:.875rem; color:#E81123; }
    /* Container */
    .container {
      max-width:700px; margin:2em auto; background:#fff; padding:2em;
      border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .top-link { text-align:right; margin-bottom:1em; }
    .top-link a {
      background:#0078D4; color:#fff; padding:0.5em 1em; border-radius:4px;
      text-decoration:none; font-size:1rem;
    }
    .school-logo { display:block; margin:0 auto 1em; max-height:60px; }
    h1, h2 { margin-top:0; }
    /* Form */
    .entry-form label { display:block; margin-bottom:.5em; font-weight:600; }
    .entry-form input[type="date"], .entry-form input[type="time"],
    .entry-form textarea, .entry-form input[type="file"] {
      width:100%; padding:.5em; border:1px solid #CBD4E1; border-radius:4px;
      margin-bottom:1em; background:#F8FBFF; box-sizing:border-box;
    }
    .entry-form input[type="checkbox"] { margin-right:.5em; }
    .entry-form button {
      background:#0078D4; color:#fff; border:none; padding:.75em 1.5em;
      border-radius:4px; font-size:1em; cursor:pointer;
    }
    .entry-form button:hover { background:#005A9E; }
    #time-container { display:none; }
    /* List */
    .entries { margin-top:2em; }
    .entries ul { list-style:none; padding:0; }
    .entries li { border-bottom:1px solid #CBD4E1; padding:1em 0; }
    .entry-meta { font-size:.9rem; color:#555; margin-bottom:.5em; }
    .entry-text { margin-bottom:.5em; }
    .entry-attachments a { margin-right:.5em; text-decoration:none; font-size:.9rem; color:#0078D4; }
    .entry-actions button {
      margin-right:.5em; padding:.3em .6em; border:none; border-radius:4px; cursor:pointer; color:#fff;
    }
    .btn-edit   { background:#FFC107; }
    .btn-delete { background:#E81123; }
    .btn-archiv { background:#107C10; }
  </style>
</head>
<body>
  <!-- Auth Overlay -->
  <div id="auth-overlay">
    <div class="auth-modal">
      <h2>Admin Login</h2>
      <input type="password" id="admin-password" placeholder="Passwort">
      <button id="auth-submit">Einloggen</button>
      <p id="auth-error" style="display:none;">Falsches Passwort</p>
    </div>
  </div>

  <div class="container">
    <div class="top-link">
      <a href="index.html" target="_blank" rel="noopener">Sch√ºler-Ansicht √∂ffnen</a>
    </div>
    <img src="https://www.schulehuttwil.ch/public/upload/assets/12/logo-huttwil.svg" alt="Schullogo Huttwil" class="school-logo">
    <h1>Neuer Eintrag</h1>
    <form class="entry-form" onsubmit="return false;">
      <label for="entry-date">Datum</label>
      <input type="date" id="entry-date" required>
      <div>
        <input type="checkbox" id="add-timestamp">
        <label for="add-timestamp" style="display:inline;font-weight:normal;">Zeitstempel hinzuf√ºgen</label>
      </div>
      <div id="time-container">
        <label for="entry-time">Zeit</label>
        <input type="time" id="entry-time">
      </div>
      <label for="entry-text">Eintrag</label>
      <textarea id="entry-text" rows="4" required></textarea>
      <label for="entry-files">Dateien (optional)</label>
      <input type="file" id="entry-files" multiple>
      <button id="submit-entry">Anzeigen &amp; hochladen</button>
    </form>

    <div class="entries">
      <h2>Aktuelle Aufgaben und Termine</h2>
      <ul id="entries-list"></ul>
    </div>
  </div>

  <script>
    // Admin-Passwort
    const ADMIN_PWD = "MeinStarkesPasswort123";
    const overlay = document.getElementById('auth-overlay');
    const input = document.getElementById('admin-password');
    const btn = document.getElementById('auth-submit');
    const err = document.getElementById('auth-error');

    btn.addEventListener('click', () => auth());
    input.addEventListener('keyup', (e) => { if (e.key === 'Enter') auth(); });
    function auth() {
      if (input.value === ADMIN_PWD) {
        overlay.style.display = 'none';
        loadEntries();
      } else {
        err.style.display = 'block';
      }
    }

    // WebDAV-Konfig
    const webdavUrl = 'https://meine-schule.ch/remote.php/webdav/tafel/';
    const archiveUrl = webdavUrl + 'archiv/';
    const authHeader = 'Basic ' + btoa('LEHRER_USER:PASSWORT');
    const MONATE = ["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];

    function formatDateDE(d) {
      const [y,m,day] = d.split('-');
      return `${parseInt(day,10)}. ${MONATE[parseInt(m,10)-1]} ${y}`;
    }

    // Toggle Zeit
    document.getElementById('add-timestamp').addEventListener('change', function(){
      const tc = document.getElementById('time-container');
      if(this.checked) {
        tc.style.display='block';
        const now = new Date();
        document.getElementById('entry-time').value = now.toTimeString().slice(0,5);
      } else tc.style.display='none';
    });

    document.getElementById('submit-entry').addEventListener('click', async ()=>{
      const sel = new Date(document.getElementById('entry-date').value);
      const today = new Date(); today.setHours(0,0,0,0);
      if (sel < today) { alert('Datum liegt in der Vergangenheit.'); return; }
      await saveEntry(); await loadEntries();
    });

    async function saveEntry() {
      const date = document.getElementById('entry-date').value;
      let name = date + (document.getElementById('add-timestamp').checked? '_' + document.getElementById('entry-time').value.replace(':',''): '');
      const filename = name + '.json';
      const entry = { date, time: document.getElementById('add-timestamp').checked? document.getElementById('entry-time').value: null, text: document.getElementById('entry-text').value, attachments: [] };
      for (let f of document.getElementById('entry-files').files) {
        const att = name + '_' + f.name;
        entry.attachments.push(att);
        await fetch(webdavUrl + encodeURIComponent(att), { method:'PUT', headers:{ 'Authorization':authHeader }, body:f });
      }
      await fetch(webdavUrl + encodeURIComponent(filename), { method:'PUT', headers:{ 'Authorization':authHeader }, body: new Blob([JSON.stringify(entry,null,2)],{type:'application/json'}) });
    }

    async function loadEntries() {
      const list = document.getElementById('entries-list');
      list.innerHTML=''; 
      try {
        const res = await fetch(webdavUrl,{method:'PROPFIND',headers:{ 'Authorization':authHeader,'Depth':'1' }});
        if(!res.ok) throw '';
        const xml = new DOMParser().parseFromString(await res.text(),'application/xml');
        const responses = Array.from(xml.querySelectorAll('response'));
        const files = responses.map(r=>decodeURIComponent(r.querySelector('href').textContent.replace(/\/$/,'').split('/').pop())).filter(f=>f.endsWith('.json'));
        for(let file of files) {
          const entry = await (await fetch(webdavUrl + encodeURIComponent(file),{headers:{'Authorization':authHeader}})).json();
          renderEntry(file, entry);
        }
      } catch {
        // no connection
      }
    }

    function renderEntry(fn, e) {
      const li = document.createElement('li');
      const meta = document.createElement('div'); meta.className='entry-meta'; meta.textContent = formatDateDE(e.date)+(e.time?' '+e.time:''); li.appendChild(meta);
      const txt = document.createElement('div'); txt.className='entry-text'; txt.textContent=e.text; li.appendChild(txt);
      if(e.attachments.length){
        const ad = document.createElement('div'); ad.className='entry-attachments';
        e.attachments.forEach(a=>{ let l=document.createElement('a'); l.href=webdavUrl+encodeURIComponent(a); l.target='_blank'; l.textContent=a.split('_').pop(); ad.appendChild(l); });
        li.appendChild(ad);
      }
      const act = document.createElement('div'); act.className='entry-actions';
      ['edit','delete','archiv'].forEach(type=>{
        let b=document.createElement('button');
        if(type==='edit'){ b.className='btn-edit'; b.textContent='‚úèÔ∏è'; }
        if(type==='delete'){ b.className='btn-delete'; b.textContent='üóëÔ∏è'; }
        if(type==='archiv'){ b.className='btn-archiv'; b.textContent='üì¶'; }
        act.appendChild(b);
      });
      li.appendChild(act); document.getElementById('entries-list').appendChild(li);
    }

    // Initial laden bleibt hinter Overlay
  </script>
</body>
</html>
