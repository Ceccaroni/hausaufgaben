<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausaufgaben-App – Anmeldung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fade-CSS -->
  <link rel="stylesheet" href="public/fade.css" />

  <!-- Gemeinsame Styles -->
  <link rel="stylesheet" href="public/style-shared.css" />
  <link rel="stylesheet" href="public/style-index.css" />

  <style>
    /* Reset & Layout */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; background: #F2F2F5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #1C1C1E;
    }
    .login-container {
      background: #FFF; border-radius: 16px; width: 360px;
      padding: 32px 24px; text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .school-logo { display: block; margin: 0 auto 24px; max-height: 60px; }
    h1 { font-size: 1.5rem; margin-bottom: 24px; font-weight: 600; color: #000; }
    .login-form { display: flex; flex-direction: column; gap: 16px; margin-bottom: 8px; }
    .login-form input, .login-form button {
      width: 100%; padding: 12px 14px; font-size: 1rem; border-radius: 8px;
    }
    .login-form input {
      border: 1px solid #D1D1D6; background: #F2F2F7; outline: none;
      transition: border-color .2s, background .2s;
    }
    .login-form input:focus { border-color: #0A84FF; background: #FFF; }
    .login-form button { background: #0A84FF; color: #FFF; border: none; cursor: pointer; }
    .login-form button:hover { background: #0066CC; }
    .error { color: #FF3B30; font-size: 0.875rem; margin-top: 8px; text-align: left; display: none; }
    .hint { font-size: .85rem; color: #6b7280; margin-top: 6px; text-align: left; }
  </style>
</head>
<body class="fade-initial">
  <div class="login-container">
    <img class="school-logo" src="assets/logo-huttwil.svg" alt="Schullogo Huttwil" />
    <h1>Anmeldung</h1>

    <!-- EIN Formular: Benutzername ODER E-Mail + Passwort -->
    <form id="login-form" class="login-form" autocomplete="off">
      <input
        type="text"
        id="login-identifier"
        name="identifier"
        placeholder="Benutzername oder E-Mail"
        required
        inputmode="email"
        autocomplete="username"
      />
      <input
        type="password"
        id="login-password"
        name="password"
        placeholder="Passwort eingeben"
        required
        autocomplete="current-password"
      />
      <button type="submit">Login</button>
      <div id="error-msg" class="error">Login fehlgeschlagen</div>
      <div class="hint">Tipp: Nur <em>Benutzername</em> eingeben reicht (wir hängen @huttwil.ch an).</div>
    </form>
  </div>

  <!-- Supabase Login & Routing -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ==== Supabase Projekt-Keys ====
    const SUPABASE_URL = 'https://dxzeleiiaitigzttbnaf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4emVsZWlpYWl0aWd6dHRibmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNDcxODQsImV4cCI6MjA3MjgyMzE4NH0.iXKtGyH0y8KUvAWLSJZKFIfz4VQ-y2PZBWucEg7ZHJ4';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // ==== Admin-Definition (Fallback, falls keine role-Metadaten) ====
    const ADMIN_EMAILS = new Set([
      'adrian.lanz@huttwil.ch'
      // weitere Admins hier ergänzen
    ]);

    // ==== Helper: Username → E-Mail (Alias-Domain) ====
    function toEmail(input, domain = 'huttwil.ch') {
      const v = (input || '').trim();
      if (!v) return '';
      return v.includes('@') ? v.toLowerCase() : `${v.toLowerCase()}@${domain}`;
    }

    // ==== Fade-In ====
    window.addEventListener('DOMContentLoaded', () => {
      document.body.classList.remove('fade-initial');
    });

    // ==== Route, wenn bereits eingeloggt (Refresh) ====
    (async () => {
      const { data } = await supabase.auth.getUser();
      const user = data?.user;
      if (!user) return;
      routeByRole(user);
    })();

    // ==== Formular-Login ====
    const form = document.getElementById('login-form');
    const idInput = document.getElementById('login-identifier');
    const pwdInput = document.getElementById('login-password');
    const errorMsg = document.getElementById('error-msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.style.display = 'none';

      const email = toEmail(idInput.value);
      const password = pwdInput.value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        errorMsg.textContent = error.message || 'Login fehlgeschlagen';
        errorMsg.style.display = 'block';
        return;
      }
      routeByRole(data.user);
    });

    // ==== Rollenbasierte Weiterleitung ====
    function routeByRole(user) {
      const role = user?.user_metadata?.role;
      const email = user?.email?.toLowerCase() || '';

      // Priorität: role-Metadaten → ansonsten E-Mail-Liste
      if (role === 'admin' || ADMIN_EMAILS.has(email)) {
        navigateWithFade('admin.html');
      } else {
        navigateWithFade('sus.html');
      }
    }

    // ==== Fade-Out Navigation ====
    function navigateWithFade(targetUrl) {
      document.body.classList.add('fade-out');
      setTimeout(() => { window.location.href = targetUrl; }, 300);
    }
  </script>

  <!-- Service Worker (unverändert) -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .catch(err => console.error('Service Worker konnte nicht registriert werden:', err));
    }
  </script>
</body>
</html>
