<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausaufgaben-App – Anmeldung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fade-CSS extern -->
  <link rel="stylesheet" href="public/fade.css" />

  <!-- Gemeinsame Styles -->
  <link rel="stylesheet" href="public/style-shared.css" />
  <link rel="stylesheet" href="public/style-index.css" />

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      display:flex;align-items:center;justify-content:center;min-height:100vh;
      background:#F2F2F5;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      color:#1C1C1E;
    }
    .login-container{
      background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.1);
      width:360px;padding:32px 24px;text-align:center
    }
    .school-logo{display:block;margin:0 auto 24px;max-height:60px}
    h1{font-size:1.5rem;margin-bottom:24px;font-weight:600;color:#000}
    .login-form{display:flex;flex-direction:column;gap:12px;margin-bottom:8px}
    .login-form input,.login-form button{
      width:100%;padding:12px 14px;font-size:1rem;border-radius:8px;
      border:1px solid #D1D1D6;background:#F2F2F7;outline:none;
      transition:border-color .2s,background .2s
    }
    .login-form input:focus{border-color:#0A84FF;background:#fff}
    .login-form button{background:#0A84FF;color:#fff;border:none;cursor:pointer}
    .login-form button:hover{background:#0066CC}
    .hint{font-size:.85rem;color:#6b7280;margin:6px 0 14px}
    .error{color:#FF3B30;font-size:.9rem;margin-top:8px;display:none;text-align:left}
  </style>
</head>
<body class="fade-initial">
  <div class="login-container">
    <img class="school-logo" src="assets/logo-huttwil.svg" alt="Schullogo Huttwil" />
    <h1>Anmeldung</h1>

    <form id="login-form" class="login-form" autocomplete="off">
      <input type="text" id="identifier" placeholder="Benutzername oder E-Mail" required />
      <input type="password" id="password" placeholder="Passwort eingeben" required />
      <button type="submit">Login</button>
    </form>

    <p class="hint">Admin & Schüler:in melden sich hier an. Benutzername ohne „@“ ist erlaubt.</p>
    <div id="error-msg" class="error">Anmeldung fehlgeschlagen.</div>
  </div>

  <!-- Supabase-Login für ALLE, Redirect je nach Admin-Status -->
  <script type="module">
    // ---- Supabase
    const SUPABASE_URL = 'https://dxzeleiiaitigzttbnaf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4emVsZWlpYWl0aWd6dHRibmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNDcxODQsImV4cCI6MjA3MjgyMzE4NH0.iXKtGyH0y8KUvAWLSJZKFIfz4VQ-y2PZBWucEg7ZHJ4';
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true },
      db: { schema: 'app' }
    });

    // ---- Konfiguration
    // Trage hier die Admin-Mail(s) ein, mit denen du dich bei Supabase eingeloggt hast:
    const ADMIN_EMAILS = [
      'adrian.lanz@huttwil.ch'
    ];
    // Username-Alias → wir hängen @schule.local an, wenn kein @ eingegeben wurde
    const USER_ALIAS_DOMAIN = 'schule.local';
    const toEmail = (id) => id.includes('@') ? id.trim() : `${id.trim()}@${USER_ALIAS_DOMAIN}`;

    // Fade
    window.addEventListener('DOMContentLoaded', () => {
      document.body.classList.remove('fade-initial');
    });
    const fadeTo = (url) => { document.body.classList.add('fade-out'); setTimeout(()=>location.href=url, 300); };

    // Bereits eingeloggt? → direkt weiterleiten
    (async () => {
      const { data } = await supabase.auth.getUser();
      const email = data?.user?.email || '';
      if (email) {
        if (ADMIN_EMAILS.map(s=>s.toLowerCase()).includes(email.toLowerCase())) fadeTo('admin.html');
        else fadeTo('sus.html');
      }
    })();

    // Submit-Handler
    const form = document.getElementById('login-form');
    const idInput = document.getElementById('identifier');
    const pwdInput = document.getElementById('password');
    const err = document.getElementById('error-msg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.style.display = 'none';
      const id = idInput.value.trim();
      const pwd = pwdInput.value.trim();
      if (!id || !pwd) return;

      try {
        const email = toEmail(id);
        const { data, error } = await supabase.auth.signInWithPassword({ email, password: pwd });
        if (error) throw error;

        const userEmail = data.user.email || '';
        if (ADMIN_EMAILS.map(s=>s.toLowerCase()).includes(userEmail.toLowerCase())) {
          fadeTo('admin.html');
        } else {
          fadeTo('sus.html');
        }
      } catch (e2) {
        err.textContent = 'Benutzername/E-Mail oder Passwort falsch.';
        err.style.display = 'block';
        pwdInput.focus();
      }
    });
  </script>
</body>
</html>
